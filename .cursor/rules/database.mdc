---
description: Database and Supabase rules - triggered when working on migrations, entities, or database-related files
globs:
  - "**/migrations/**/*"
  - "**/entities/**/*"
  - "**/supabase/**/*"
  - "**/*.sql"
alwaysApply: false
---

# Database Rules (Supabase / PostgreSQL)

## Table Design Standards

### Required Fields (Every Table)
- `id` - UUID, primary key, default `gen_random_uuid()`
- `created_at` - TIMESTAMPTZ, default `now()`, not null
- `updated_at` - TIMESTAMPTZ, default `now()`, not null

### Optional Common Fields
- `created_by` - UUID, foreign key to users
- `updated_by` - UUID, foreign key to users
- `deleted_at` - TIMESTAMPTZ, for soft deletes
- `is_active` - BOOLEAN, default true

## Naming Conventions
- Tables: snake_case, plural (e.g., `user_profiles`, `student_enrollments`)
- Columns: snake_case (e.g., `first_name`, `created_at`)
- Foreign keys: `{singular_table}_id` (e.g., `user_id`, `school_id`)
- Junction tables: `{table1}_{table2}` alphabetically (e.g., `role_permissions`)
- Indexes: `idx_{table}_{column(s)}`
- Constraints: `{table}_{column}_{type}` (e.g., `users_email_unique`)

## Row Level Security (RLS) - MANDATORY

### Enable RLS on ALL Tables
```sql
ALTER TABLE table_name ENABLE ROW LEVEL SECURITY;
```

### Common Policy Patterns
```sql

-- Users see data from their organization
CREATE POLICY "org_data" ON table_name
  FOR ALL USING (
    organization_id IN (
      SELECT organization_id FROM user_organizations 
      WHERE user_id = auth.uid()
    )
  );

-- Public read, authenticated write
CREATE POLICY "public_read" ON table_name
  FOR SELECT USING (true);
  
CREATE POLICY "auth_write" ON table_name
  FOR INSERT WITH CHECK (auth.uid() IS NOT NULL);
```

### Multi-Tenant (Branch-Based) Pattern
```sql
-- Users can only access data from their assigned branches
CREATE POLICY "branch_isolation" ON table_name
  FOR ALL USING (
    branch_id IN (
      SELECT branch_id FROM user_branches 
      WHERE user_id = auth.uid() AND is_active = true
    )
  );
```

## Foreign Key Rules
- Always define ON DELETE behavior (CASCADE, SET NULL, RESTRICT)
- Use RESTRICT for critical relationships (prevent accidental deletion)
- Use CASCADE for child records that should be deleted with parent
- Use SET NULL for optional relationships

## Indexes
- Primary keys are indexed automatically
- Add indexes on:
  - Foreign key columns
  - Columns used in WHERE clauses
  - Columns used in ORDER BY
  - Columns used in JOIN conditions
- Consider composite indexes for multi-column queries

## Data Types
- IDs: `UUID`
- Text: `VARCHAR(n)` with appropriate limit, or `TEXT` for unlimited
- Numbers: `INTEGER`, `BIGINT`, `NUMERIC(precision, scale)`
- Booleans: `BOOLEAN`
- Dates: `DATE`, `TIMESTAMPTZ` (always with timezone)
- JSON: `JSONB` (not `JSON`)
- Enums: Create custom enum types or use VARCHAR with CHECK

## Migration Best Practices
- One migration per logical change
- Migrations must be reversible (provide down migration)
- Never modify existing migrations after they're deployed
- Test migrations on copy of production data
- Include data migrations separately from schema migrations

## Supabase-Specific

### Auth Integration
- Use `auth.uid()` to get current user in RLS policies
- Link application users to `auth.users` via `auth_id` column
- Never store passwords - Supabase Auth handles this

### Realtime
- Enable realtime only on tables that need it
- Consider performance impact of realtime on large tables

### Storage
- Use Supabase Storage for files
- Set up storage policies similar to RLS
- Never store files as base64 in database

## Security Checklist
- [ ] RLS enabled on all tables
- [ ] Policies defined for all CRUD operations
- [ ] No SELECT * in RLS policies (be explicit)
- [ ] Foreign keys properly constrained
- [ ] Sensitive columns encrypted or excluded
- [ ] Audit trail for sensitive operations
- [ ] Backup strategy defined

## Performance
- Avoid SELECT * - specify columns
- Use LIMIT for large result sets
- Add indexes for slow queries
- Consider partitioning for very large tables
- Use connection pooling (Supabase handles this)
